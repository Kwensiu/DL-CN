{
    "version": "7.61.5.120",
    "description": "百度网盘 PC 版",
    "homepage": "https://pan.baidu.com/",
    "license": {
        "identifier": "Proprietary",
        "url": "https://pan.baidu.com/disk/duty/"
    },
    "architecture": {
        "64bit": {
            "url": "http://issuecdn.baidupcs.com/issue/netdisk/yunguanjia/BaiduNetdisk_7.61.5.120.exe#/dl.7z",
            "hash": "f564c9556164d3dfa0a14131a674155e5a211f51be18d6542f3b3ebc16defbe1"
        }
    },
    "shortcuts": [
        [
            "BaiduNetdisk.exe",
            "百度网盘"
        ]
    ],
    "persist": [
        "users",
        "baidunetdisk"
    ],
    "installer": {
        "script": [
            "# 1. 停止可能正在运行的百度网盘进程",
            "$baiduProcesses = @('BaiduNetdisk', 'BaiduNetdiskHost', 'YunDetectService','baiduYunGuanjia')",
            "foreach ($proc in $baiduProcesses) {",
            "    Get-Process -Name $proc -ErrorAction SilentlyContinue | Stop-Process -Force",
            "}",
            "Start-Sleep -Seconds 1",
            "",
            "# 2. 动态查找安装程序（解决版本号问题）",
            "$installer = Get-ChildItem -Path \"$dir\" -Filter \"*.exe\" | Where-Object {",
            "    $_.Name -match '^BaiduNetdisk' -and $_.Name -notmatch '\\.7z$'",
            "} | Select-Object -First 1 -ExpandProperty Name",
            "if (-not $installer) {",
            "    # 如果没找到，尝试更宽松的匹配",
            "    $installer = (Get-ChildItem -Path \"$dir\" -Filter \"*.exe\" | Select-Object -First 1 -ExpandProperty Name)",
            "}",
            "",
            "if (-not $installer) {",
            "    throw \"未找到安装程序\"",
            "}",
            "",
            "Write-Host \"找到安装程序: $installer\" -ForegroundColor Green",
            "",
            "# 3. 使用静默安装参数运行安装程序，但不等待它结束（因为百度网盘可能会自动启动）",
            "Write-Host \"正在静默安装...\" -ForegroundColor Yellow",
            "$installPath = \"$dir\\$installer\"",
            "$process = Start-Process -FilePath $installPath -ArgumentList '/S' -PassThru -NoNewWindow",
            "",
            "# 4. 等待安装程序主进程结束（最多120秒）",
            "$timeout = 120",
            "for ($i = 0; $i -lt $timeout; $i++) {",
            "    if ($process.HasExited) {",
            "        Write-Host \"安装程序已退出\" -ForegroundColor Green",
            "        break",
            "    }",
            "    Write-Progress -Activity \"安装中\" -Status \"已等待 $i 秒\" -PercentComplete (($i / $timeout) * 100)",
            "    Start-Sleep -Seconds 1",
            "}",
            "",
            "# 5. 再次停止可能被安装程序启动的进程",
            "Start-Sleep -Seconds 2",
            "foreach ($proc in $baiduProcesses) {",
            "    Get-Process -Name $proc -ErrorAction SilentlyContinue | Stop-Process -Force",
            "}",
            "",
            "# 6. 根据图片创建目录结构",
            "$baiduDataPath = \"$persist_dir\\baidunetdisk\"",
            "New-Item -ItemType Directory -Force -Path $baiduDataPath | Out-Null",
            "",
            "# 创建图片中显示的所有目录",
            "$subDirs = @(",
            "    'blob_storage',",
            "    'blob_storage\\',",
            "    'Cache',",
            "    'Cache\\Cache_Data',",
            "    'Code Cache\\js',",
            "    'Code Cache\\js\\index-dir',",
            "    'Code Cache\\wasm',",
            "    'Code Cache\\wasm\\index-dir',",
            "    'databases',",
            "    'DawnCache',",
            "    'GPUCache',",
            "    'Local Storage',",
            "    'Local Storage\\leveldb',",
            "    'Network',",
            "    'Session Storage',",
            "    'Storage',",
            "    'Storage\\ext',",
            "    'Storage\\ext\\fake-host',",
            "    'Storage\\ext\\fake-host\\def',",
            "    'Storage\\ext\\fake-host\\def\\DawnCache',",
            "    'Storage\\ext\\fake-host\\def\\GPUCache',",
            ")",
            "",
            "foreach ($subDir in $subDirs) {",
            "    $fullPath = \"$baiduDataPath\\$subDir\"",
            "    if (-not (Test-Path $fullPath)) {",
            "        New-Item -ItemType Directory -Force -Path $fullPath | Out-Null",
            "    }",
            "}",
            "",
            "# 7. 迁移现有数据（如果存在）",
            "$roamingPath = [Environment]::GetFolderPath('ApplicationData')",
            "$targetBaiduDir = \"$roamingPath\\baidunetdisk",
            "",
            "if (Test-Path $targetBaiduDir) {",
            "    # 检查是否是符号链接",
            "    $item = Get-Item $targetBaiduDir -ErrorAction SilentlyContinue",
            "    if ($item.LinkType -in @('Junction', 'SymbolicLink')) {",
            "        # 如果是符号链接，直接移除",
            "        Remove-Item $targetBaiduDir -Force -Recurse",
            "    } else {",
            "        # 如果是真实目录，迁移数据",
            "        Write-Host \"迁移现有数据...\" -ForegroundColor Yellow",
            "        $backupDir = \"$targetuDir.backup.$(Get-Date -Format 'yyyyMMddHHmmss')\"",
            "        Move-Item -Path $targetBaiduDir -Destination $backupDir -Force",
            "        Write-Host \"原数据已备份到: $backupDir\" -ForegroundColor Yellow",
            "    }",
            "}",
            "",
            "# 8. 创建符号链接（指向Scoop持久化目录）",
            "New-Item -ItemType Junction -Path $targetBaiduDir -Target $baidu -Force | Out-Null",
            "Write-Host \"符号链接创建完成\" -ForegroundColor Green"
        ]
    },
    "post_install": [
        "# 清理安装文件",
        "Get-ChildItem \"$dir\" -Include '*.exe', '*.msi', 'setup.exe' | Remove-Item -Force -ErrorAction SilentlyContinue",
        "Remove-Item \"$dir\\`$PLUGINSDIR\" -Recurse -ErrorAction SilentlyContinue",
        "Remove-Item \"$dir\\`$TEMP\" -Recurse -ErrorAction SilentlyContinue",
        "Remove-Item \"$dir\\BaiduNetdisk_*.exe\" -ErrorAction SilentlyContinue"
    ],
    "pre_uninstall": [
        "# 停止相关进程",
        "$processes = @('YunDetectService', 'BaiduNetdisk', 'BaiduNetdiskHost', 'BaiduYunGuanjia')",
        "foreach ($processName in $processes) {",
        "    Get-Process -Name $processName -ErrorAction SilentlyContinue | Stop-Process -Force",
        "}"
    ],
    "post_uninstall": [
        "# 清理符号链接但保留数据",
        "$roamingPath = [Environment]::GetFolderPath('ApplicationData')",
        "$targetDir = \"$roamingPath\\baidunetdisk\"",
        "",
        "if (Test-Path $targetDir) {",
        "    $item = Get-Item $targetDir -ErrorAction SilentlyContinue",
        "    if ($item.LinkType -in @('Junction', 'SymbolicLink')) {",
        "        Remove-Item $targetDir -Force",
        "        Write-Host \"已移除符号链接\" -ForegroundColor Green",
        "}",
        "}",
        "",
        "# 清理其他缓存（可选）",
        "$cacheDirs = @(",
        "    \"$env:APPDATA\\Baidu\",",
        "    \"$env:APPDATA\\BaiduYunGuanjia\",",
        "    \"$env:APPDATA\\BaiduYunKernel\",",
        "    \"$env:LOCALAPPDATA\\BaiduYunKernel\"",
        ")",
        "foreach ($cacheDir in $cacheDirs) {",
        "    if (Test-Path $cacheDir) {",
        "        Remove-Item $cacheDir -Force -RecErrorAction SilentlyContinue",
        "    }",
        "}"
    ],
    "checkver": {
        "url": "https://pan.baidu.com/disk/cmsdata?do=client",
        "jsonpath": "$.guanjia.url",
        "regex": "BaiduNetdisk_([\\d.]+).exe"
    },
    "autoupdate": {
        "url": "http://issuecdn.baidupcs.com/issue/netdisk/yunguanjia/BaiduNetdisk_$version.exe#/dl.7z"
    }
}
