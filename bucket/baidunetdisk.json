{
    "version": "7.61.5.120",
    "description": "百度网盘 PC 版",
    "homepage": "https://pan.baidu.com/",
    "license": {
        "identifier": "Proprietary",
        "url": "https://pan.baidu.com/disk/duty/"
    },
    "architecture": {
        "64bit": {
            "url": "http://issuecdn.baidupcs.com/issue/netdisk/yunguanjia/BaiduNetdisk_7.61.5.120.exe#/dl.7z",
            "hash": "f564c9556164d3dfa0a14131a674155e5a211f51be18d6542f3b3ebc16defbe1"
        }
    },
    "shortcuts": [
        [
            "BaiduNetdisk.exe",
            "百度网盘"
        ]
    ],
    "persist": [
        "users",
        "baidunetdisk"
    ],
    "installer": {
        "script": [
            "# 动态查找安装程序（解决硬编码版本号问题）",
            "$installer = Get-ChildItem -Path \"$dir\" -Filter \"BaiduNetdisk_*.exe\" | Select-Object -First 1 -ExpandProperty Name",
            "if (-not $installer) {",
            "    $installer = \"BaiduNetdisk.exe\"",
            "}",
            "",
            "Write-Host \"找到安装程序: $installer\" -ForegroundColor Green",
            "Start-Process -Wait -FilePath \"$dir\\$installer\" -ArgumentList '/S'",
            "",
            "# 根据图片中的结构创建持久化目录",
            "$baiduDataPath = \"$persist_dir\\baidunetdisk\"",
            "New-Item -ItemType Directory -Force -Path $baiduDataPath | Out-Null",
            "",
            "# 创建图片中显示的所有目录",
            "$subDirs = @(",
            "    'Code Cache\\js',",
            "    'Code Cache\\wasm',",
            "    'IndexedDB',",
            "    'Local Storage',",
            "    'Storage\\ext\\fake-host\\def',",
            "    'Storage\\ext\\def',",
            "    'DawnCache',",
            "    'GPCuCache'",
            ")",
            "",
            "foreach ($subDir in $subDirs) {",
            "    $fullPath = \"$baiduDataPath\\$subDir\"",
            "    if (-not (Test-Path $fullPath)) {",
            "        New-Item -ItemType Directory -Force -Path $fullPath | Out-Null",
            "        Write-Host \"创建目录: $subDir\" -ForegroundColor DarkGray",
            "    }",
            "}",
            "",
            "# 创建符号链接，将系统目录重定向到持久化目录",
            "$roamingPath = [Environment]::GetFolderPath('ApplicationData')",
            "$targetDir = \"$roamingPath\\baidunetdisk\"",
            "$sourceDir = $baiduDataPath",
            "",
            "# 如果已存在目标目录，先备份现有数据",
            "if (Test-Path $targetDir) {",
            "    $linkInfo = Get-Item $targetDir -ErrorAction SilentlyContinue",
            "    if ($linkInfo.LinkType -ne 'Junction' -and $linkInfo.LinkType -ne 'SymbolicLink') {",
            "        Write-Host \"发现现有数据，正在迁移...\" -ForegroundColor Yellow",
            "        $backupPath = \"$targetDir.backup.$(Get-Date -Format 'yyyyMMddHHmmss')\"",
            "        Move-Item -Path $targetDir -Destination $backupPath -Force",
            "        Write-Host \"数据已备份到: $backupPath\" -ForegroundColor Yellow",
            "    } else {",
            "        # 如果是符号链接，直接移除",
            "        Remove-Item $targetDir -Force -Recurse",
            "    }",
            "}",
            "",
            "# 创建符号链接",
            "New-Item -ItemType Junction -Path $targetDir -Target $sourceDir -Force | Out-Null",
            "Write-Host \"已创建符号链接: \" -NoNewline -ForegroundColor Green",
            "Write-Host \"$targetDir -> $sourceDir\" -ForegroundColor Cyan"
        ]
    },
    "post_install": [
        "# 清理安装临时文件",
        "Remove-Item \"$dir\\`$PLUGINSDIR\" -Recurse -ErrorAction SilentlyContinue",
        "Remove-Item \"$dir\\`$TEMP\" -Recurse -ErrorAction SilentlyContinue",
        "Remove-Item \"$dir\\BaiduNetdisk_*.exe\" -ErrorAction SilentlyContinue"
    ],
    "pre_uninstall": [
        "# 停止相关进程",
        "$processes = @('YunDetectService', 'BaiduNetdisk', 'BaiduNetdiskHost')",
        "foreach ($processName in $processes) {",
        "    if (Get-Process -Name $processName -ErrorAction SilentlyContinue) {",
        "        Stop-Process -Name $processName -Force",
        "        Write-Host \"已停止进程: $processName\" -ForegroundColor Yellow",
        "    }",
        "}",
        "",
        "# 等待进程完全退出",
        "Start-Sleep -Seconds 2"
    ],
    "post_uninstall": [
        "# 清理符号链接（但保留持久化数据）",
        "$roamingPath = [Environment]::GetFolderPath('ApplicationData')",
        "$targetDir = \"$roamingPath\\baidunetdisk\"",
        "",
        "if (Test-Path $targetDir) {",
        "    if ((Get-Item $targetDir -ErrorAction SilentlyContinue).Attributes -match 'ReparsePoint') {",
        "        Remove-Item $targetDir -Force",
        "        Write-Host '已移除符号链接' -ForegroundColor Green",
        "    }",
        "}",
        "",
        "# 选择性清理其他缓存（可选）",
        "$cacheDirs = @(",
        "    \"$env:APPDATA\\Baidu\",",
        "    \"$env:APPDATA\\BaiduYunGuanjia\",",
        "    \"$env:APPDATA\\BaiduYunKernel\",",
        "    \"$env:LOCALAPPDATA\\BaiduYunKernel\"",
        ")",
        "",
        "foreach ($cacheDir in $cacheDirs) {",
        "    if (Test-Path $cacheDir) {",
        "        Remove-Item $cacheDir -Force -Recurse -ErrorAction SilentlyContinue",
        "        Write-Host \"已清理缓存: $cacheDir\" -ForegroundColor Yellow",
        "    }",
        "}"
    ],
    "checkver": {
        "url": "https://pan.baidu.com/disk/cmsdata?do=client",
        "jsonpath": "$.guanjia.url",
        "regex": "BaiduNetdisk_([\\d.]+).exe"
    },
    "autoupdate": {
        "url": "http://issuecdn.baidupcs.com/issue/netdisk/yunguanjia/BaiduNetdisk_$version.exe#/dl.7z"
    }
}
